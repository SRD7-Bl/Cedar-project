<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç‰©èµ„ç®¡ç†ç³»ç»Ÿ</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#101833;
      --panel2:#0f1630;
      --card:#111b3a;
      --card2:#0e1633;
      --text:#e9eeff;
      --muted:#a8b4dd;
      --line:rgba(255,255,255,.10);
      --shadow: 0 12px 30px rgba(0,0,0,.40);
      --radius:16px;

      --accent:#7aa2ff;
      --good:#5de4c7;
      --warn:#ffd37a;
      --bad:#ff6b81;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 800px at 20% -10%, rgba(122,162,255,.18), transparent 55%),
        radial-gradient(900px 700px at 90% 0%, rgba(93,228,199,.10), transparent 55%),
        radial-gradient(1000px 900px at 10% 110%, rgba(255,107,129,.08), transparent 55%),
        var(--bg);
      color:var(--text);
    }

    .app{
      max-width:1200px;
      margin: 26px auto 80px;
      padding: 0 18px;
    }

    /* Top Bar */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 16px 16px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 14px;
      z-index: 5;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 260px;
    }
    .logo{
      width:42px;height:42px;border-radius:14px;
      background: radial-gradient(circle at 30% 30%, rgba(122,162,255,.9), rgba(93,228,199,.55) 45%, rgba(255,255,255,.15) 70%);
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 10px 20px rgba(0,0,0,.35);
      flex: 0 0 auto;
    }
    .titlewrap{ line-height:1.05; }
    .title{
      font-size: 15px;
      font-weight: 760;
      letter-spacing: .2px;
    }
    .subtitle{
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
    }

    .controls{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:10px;
      flex: 1;
      flex-wrap: wrap;
    }

    .input{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(15,22,48,.55);
      min-width: 240px;
    }
    .input input{
      width: 100%;
      border: 0;
      outline: none;
      background: transparent;
      color: var(--text);
      font-size: 14px;
    }
    .input .hint{
      font-size: 12px;
      color: var(--muted);
      opacity:.9;
      white-space: nowrap;
    }

    select{
      border: 1px solid var(--line);
      background: rgba(15,22,48,.55);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 10px;
      font-size: 13px;
      outline: none;
    }

    .btn{
      border: 1px solid var(--line);
      background: rgba(15,22,48,.55);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 13px;
      cursor:pointer;
      transition: transform .05s ease, background .15s ease, border-color .15s ease;
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn:hover{ border-color: rgba(255,255,255,.22); background: rgba(15,22,48,.72); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(180deg, rgba(122,162,255,.28), rgba(122,162,255,.12));
      border-color: rgba(122,162,255,.35);
    }
    .btn.danger{
      background: linear-gradient(180deg, rgba(255,107,129,.22), rgba(255,107,129,.10));
      border-color: rgba(255,107,129,.35);
    }
    .pill{
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      color: var(--muted);
      font-size: 12px;
      background: rgba(15,22,48,.35);
    }

    /* Content */
    .section{
      margin-top: 16px;
      display:flex;
      gap:14px;
      align-items:stretch;
      flex-wrap: wrap;
    }
    .panel{
      flex: 1 1 320px;
      min-width: 280px;
      padding: 14px 14px;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(16,24,51,.55);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .panel h3{
      margin: 0 0 6px;
      font-size: 13px;
      color: var(--muted);
      font-weight: 650;
      letter-spacing: .2px;
    }
    .stats{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      align-items:center;
    }
    .stat{
      background: rgba(15,22,48,.35);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 10px 12px;
      min-width: 170px;
    }
    .stat .k{ font-size: 12px; color: var(--muted); }
    .stat .v{ margin-top: 6px; font-weight: 750; font-size: 18px; letter-spacing:.2px; }

    /* Grid */
    .grid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 14px;
    }

    .card{
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      overflow:hidden;
      box-shadow: var(--shadow);
      position: relative;
    }
    .imgwrap{
      width:100%;
      aspect-ratio: 4 / 3;
      background: rgba(15,22,48,.5);
      border-bottom: 1px solid var(--line);
      position: relative;
      overflow:hidden;
    }
    .imgwrap img{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
      filter: saturate(1.05) contrast(1.02);
      transform: scale(1.02);
    }
    .imgwrap .ph{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      color: rgba(233,238,255,.35);
      font-size: 12px;
      letter-spacing:.2px;
      background:
        radial-gradient(900px 600px at 30% 30%, rgba(122,162,255,.22), transparent 45%),
        radial-gradient(700px 500px at 80% 20%, rgba(93,228,199,.14), transparent 50%),
        rgba(15,22,48,.45);
    }

    .cardbody{ padding: 12px 12px 10px; }
    .nameRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 8px;
    }
    .name{
      font-weight: 760;
      font-size: 14px;
      letter-spacing:.2px;
      line-height:1.2;
    }
    .id{
      font-size: 11px;
      color: var(--muted);
      opacity:.85;
      user-select:text;
      white-space: nowrap;
    }
    .meta{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .chip{
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(15,22,48,.35);
      font-size: 12px;
      color: var(--muted);
    }
    .chip strong{
      color: var(--text);
      font-weight: 760;
      margin-left: 4px;
    }
    .note{
      color: var(--muted);
      font-size: 12px;
      line-height:1.35;
      min-height: 32px;
      opacity:.92;
    }

    .actions{
      display:flex;
      gap:8px;
      flex-wrap: wrap;
      margin-top: 10px;
      align-items:center;
      justify-content:space-between;
    }
    .qtyCtl{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .mini{
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 12px;
    }
    .mini.primary{ border-color: rgba(122,162,255,.35); }
    .mini.danger{ border-color: rgba(255,107,129,.35); }

    .qty{
      min-width: 54px;
      text-align:center;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(15,22,48,.35);
      font-weight: 760;
    }

    .footerbar{
      margin-top: 18px;
      padding: 12px 14px;
      border-radius: var(--radius);
      border: 1px dashed rgba(255,255,255,.18);
      color: var(--muted);
      font-size: 12px;
      background: rgba(16,24,51,.25);
    }

    /* Modal */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.58);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 20px;
      z-index: 20;
    }
    .modal{
      width: min(680px, 100%);
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(16,24,51,.92), rgba(12,17,36,.92));
      box-shadow: 0 22px 60px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modalHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 14px 14px;
      border-bottom: 1px solid var(--line);
    }
    .modalHeader .h{
      font-weight: 780;
      letter-spacing:.2px;
    }
    .modalBody{
      padding: 14px 14px 4px;
    }
    .formGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .field label{
      font-size: 12px;
      color: var(--muted);
    }
    .field input, .field textarea{
      border: 1px solid var(--line);
      background: rgba(15,22,48,.55);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 10px;
      outline:none;
      font-size: 13px;
    }
    .field textarea{
      min-height: 82px;
      resize: vertical;
      grid-column: 1 / -1;
    }
    .modalFooter{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      padding: 12px 14px;
      border-top: 1px solid var(--line);
      background: rgba(15,22,48,.25);
    }

    /* Toast */
    .toastWrap{
      position: fixed;
      right: 16px;
      bottom: 16px;
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index: 50;
    }
    .toast{
      width: min(360px, calc(100vw - 32px));
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(16,24,51,.90);
      box-shadow: 0 18px 44px rgba(0,0,0,.55);
      padding: 12px 12px;
      color: var(--text);
      backdrop-filter: blur(10px);
      animation: pop .18s ease-out;
    }
    @keyframes pop{ from{ transform: translateY(8px); opacity:.0 } to{ transform: translateY(0); opacity:1 } }
    .toast .t{ font-weight: 780; font-size: 13px; }
    .toast .m{ margin-top: 6px; color: var(--muted); font-size: 12px; line-height:1.35; }
    .toast.good{ border-color: rgba(93,228,199,.35); }
    .toast.warn{ border-color: rgba(255,211,122,.35); }
    .toast.bad{ border-color: rgba(255,107,129,.35); }

    @media (max-width: 720px){
      .brand{ min-width: unset; }
      .formGrid{ grid-template-columns: 1fr; }
      .input{ min-width: 180px; }
    }
  </style>
</head>

<body>
  <div class="app">

    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="titlewrap">
          <div class="title">ç‰©èµ„ç®¡ç†ç³»ç»Ÿ</div>
          <div class="subtitle">UI Prototype Â· å›¾ç‰‡å¡ç‰‡å¼ç‰©å“ç®¡ç†</div>
        </div>
      </div>

      <div class="controls">
        <div class="input" title="æŒ‰åç§°/ID/å¤‡æ³¨æœç´¢">
          <span class="hint">ğŸ”</span>
          <input id="searchInput" placeholder="Search items..." />
        </div>

        <select id="sortSelect" title="æ’åº">
          <option value="name_asc">åå­— â†‘</option>
          <option value="name_desc">åå­— â†“</option>
          <option value="price_asc">ä»·æ ¼ â†‘</option>
          <option value="price_desc">ä»·æ ¼ â†“</option>
          <option value="qty_asc">æ•°é‡ â†‘</option>
          <option value="qty_desc">æ•°é‡ â†“</option>
        </select>

        <button class="btn primary" id="addBtn">ï¼‹ æ·»åŠ æ–°ç‰©å“</button>
        <span class="pill" id="countPill">0 æ•°é‡</span>
      </div>
    </div>

    <div class="section">
      <div class="panel">
        <h3>å¿«é€Ÿç»Ÿè®¡:</h3>
        <div class="stats">
          <div class="stat">
            <div class="k">æ€»ç‰©å“ç§ç±»æ•°é‡</div>
            <div class="v" id="statTotal">0</div>
          </div>
          <div class="stat">
            <div class="k">æ€»ç‰©å“æ•°é‡</div>
            <div class="v" id="statQty">0</div>
          </div>
          <div class="stat">
            <div class="k">æ€»å…±ä»·å€¼</div>
            <div class="v" id="statValue">0</div>
          </div>
        </div>
      </div>

      <div class="panel">
        <h3>è§„åˆ™</h3>
        <div style="color:var(--muted); font-size:12px; line-height:1.5;">
          â€¢ ç‰©å“æ”¯æŒå›¾ç‰‡å±•ç¤ºï¼ˆimg urlï¼‰<br/>
          â€¢ å¯æ·»åŠ /ç¼–è¾‘ç‰©å“ï¼šåå­— / ä»·æ ¼ / æ•°é‡ / å›¾ç‰‡ / å¤‡æ³¨<br/>
          â€¢ é€šè¿‡ + / - å¿«é€Ÿè°ƒæ•´åº“å­˜<br/>
          â€¢ <b style="color:var(--text)">æ•°é‡ä¸º0 â†’ è‡ªåŠ¨åˆ é™¤è¯¥ç‰©å“</b><br/>
          â€¢ å½“å‰ä¸ºæœ¬åœ° demoï¼ˆæ—  DBï¼‰ï¼Œä¹‹åæ¥ Spreadsheet ç›´æ¥æ›¿æ¢æ•°æ®å±‚
        </div>
      </div>
    </div>

    <div class="grid" id="grid"></div>

    <div class="footerbar">
      Tipï¼šåç»­æ¥ DB æ—¶ï¼Œä½ åªéœ€è¦æŠŠ items çš„æ¥æºä»â€œæœ¬åœ°æ•°ç»„â€æ¢æˆ â€œloadItems()â€ï¼Œä»¥åŠæŠŠ add/update/delete æ¢æˆ POST åˆ° Apps Scriptã€‚UI ä¸ç”¨å¤§æ”¹ã€‚
    </div>
  </div>

  <!-- æ–°ç‰©å“æ·»åŠ è¡¨å• --> 
  <div class="modalBack" id="modalBack" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modalHeader">
        <div class="h" id="modalTitle">æ·»åŠ ç‰©å“</div>
        <button class="btn mini" id="closeModalBtn">âœ•</button>
      </div>

      <div class="modalBody">
        <div class="formGrid">
          <div class="field">
            <label>åå­—</label>
            <input id="fName" placeholder="e.g. é“…ç¬”" />
          </div>
          <div class="field">
            <label>ä»·æ ¼ (ç§¯åˆ†)</label>
            <input id="fPrice" type="number" min="0" step="1" placeholder="e.g. 20" />
          </div>
          <div class="field">
            <label>æ•°é‡</label>
            <input id="fQty" type="number" min="0" step="1" placeholder="e.g. 15" />
          </div>
          <div class="field">
            <label>å›¾ç‰‡åœ°å€</label>
            <input id="fImg" placeholder="https://..." />
          </div>
          <div class="field" style="grid-column:1/-1;">
            <label>å¤‡æ³¨</label>
            <textarea id="fNote" placeholder="ä¸€äº›å¤‡æ³¨..."></textarea>
          </div>
        </div>
      </div>

      <div class="modalFooter">
        <button class="btn danger" id="deleteBtn" style="display:none;">åˆ é™¤</button>
        <button class="btn" id="cancelBtn">å–æ¶ˆ</button>
        <button class="btn primary" id="saveBtn">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toastWrap" id="toastWrap"></div>

  <script>
    // ---------- Local Demo Data ----------
    /** @type {{item_id:string,name:string,price:number,qty:number,img_url:string,note:string,updated_at:string}[]} */
    let items = [
      {
        item_id: "I_20260123_a1f2",
        name: "Pencil",
        price: 20,
        qty: 12,
        img_url: "",
        note: "HB Â· for writing",
        updated_at: new Date().toISOString()
      },
      {
        item_id: "I_20260123_b8c1",
        name: "Notebook",
        price: 60,
        qty: 6,
        img_url: "https://images.unsplash.com/photo-1524995997946-a1c2e315a42f?auto=format&fit=crop&w=1200&q=60",
        note: "A5 Â· lined",
        updated_at: new Date().toISOString()
      },
      {
        item_id: "I_20260123_c9d0",
        name: "Eraser",
        price: 15,
        qty: 20,
        img_url: "https://images.unsplash.com/photo-1588072432836-7fb78b1db6da?auto=format&fit=crop&w=1200&q=60",
        note: "",
        updated_at: new Date().toISOString()
      }
    ];

    // ---------- State ----------
    let searchQ = "";
    let sortKey = "name_asc";
    let editingId = null;

    // ---------- DOM ----------
    const grid = document.getElementById("grid");
    const searchInput = document.getElementById("searchInput");
    const sortSelect = document.getElementById("sortSelect");
    const countPill = document.getElementById("countPill");

    const statTotal = document.getElementById("statTotal");
    const statQty = document.getElementById("statQty");
    const statValue = document.getElementById("statValue");

    const modalBack = document.getElementById("modalBack");
    const modalTitle = document.getElementById("modalTitle");
    const closeModalBtn = document.getElementById("closeModalBtn");
    const addBtn = document.getElementById("addBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const saveBtn = document.getElementById("saveBtn");
    const deleteBtn = document.getElementById("deleteBtn");

    const fName = document.getElementById("fName");
    const fPrice = document.getElementById("fPrice");
    const fQty = document.getElementById("fQty");
    const fImg = document.getElementById("fImg");
    const fNote = document.getElementById("fNote");

    const toastWrap = document.getElementById("toastWrap");

    // ---------- Helpers ----------
    const fmt = new Intl.NumberFormat("en-US");

    function genId(){
      return `I_${Date.now()}_${Math.random().toString(16).slice(2,6)}`;
    }

    function normalizeImgUrl(url){
      // å¯é€‰ï¼šæœªæ¥æ¥ Drive é“¾æ¥æ—¶åœ¨è¿™åšè½¬æ¢
      return (url || "").trim();
    }

    function toast(type, title, msg){
      const el = document.createElement("div");
      el.className = `toast ${type || ""}`;
      el.innerHTML = `<div class="t">${escapeHtml(title)}</div><div class="m">${escapeHtml(msg || "")}</div>`;
      toastWrap.appendChild(el);
      setTimeout(()=> {
        el.style.opacity = "0";
        el.style.transform = "translateY(6px)";
        el.style.transition = "all .18s ease";
        setTimeout(()=> el.remove(), 180);
      }, 2200);
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // è®¡ç®—å¿«é€Ÿç»Ÿè®¡é‡Œçš„ä¸€äº›æ•°æ®
    function computeStats(list){
      let total = list.length;
      let qty = 0;
      let value = 0;
      for(const it of list){
        qty += Number(it.qty || 0);
        value += Number(it.qty || 0) * Number(it.price || 0);
      }
      statTotal.textContent = fmt.format(total);
      statQty.textContent = fmt.format(qty);
      statValue.textContent = fmt.format(value);
      countPill.textContent = `${total} items`;
    }


    function filteredSorted(){
      const s = searchQ.trim().toLowerCase(); //æ ¹æ®search keywordè¿›è¡Œç­›é€‰
      let list = items.filter(it => {
        if(!s) return true;
        return (
          it.name.toLowerCase().includes(s) ||
          it.item_id.toLowerCase().includes(s) ||
          (it.note || "").toLowerCase().includes(s)
        );
      });

      const [k, dir] = sortKey.split("_"); //æ ¹æ®filteré€‰æ‹©çš„æ ‡ç­¾ç­›é€‰
      const mul = dir === "asc" ? 1 : -1; //æ­£åº/å€’åº
      list.sort((a,b) => {
        if(k === "name"){
          return a.name.localeCompare(b.name) * mul;
        }
        if(k === "price"){
          return (a.price - b.price) * mul;
        }
        if(k === "qty"){
          return (a.qty - b.qty) * mul;
        }
        return 0;
      });

      return list;
    }

    // ---------- Render ----------
    function render(){
      const list = filteredSorted();
      computeStats(list);

      grid.innerHTML = "";
      for(const it of list){
        const card = document.createElement("div");
        card.className = "card";

        const img = normalizeImgUrl(it.img_url);
        const imgHtml = img
          ? `<img src="${escapeHtml(img)}" alt="${escapeHtml(it.name)}" onerror="this.style.display='none'; this.parentElement.querySelector('.ph').style.display='flex';" />`
          : ``;

          //æ¸²æŸ“æ¯ä¸€ä¸ªå•†å“card
        card.innerHTML = `
          <div class="imgwrap">
            ${imgHtml}
            <div class="ph" style="display:${img ? "none":"flex"};">æ²¡æœ‰ç…§ç‰‡</div>
          </div>
          <div class="cardbody">
            <div class="nameRow">
              <div class="name">${escapeHtml(it.name)}</div>
              <div class="id">${escapeHtml(it.item_id)}</div>
            </div>

            <div class="meta">
              <div class="chip">Price<strong>${fmt.format(it.price)}</strong></div>
              <div class="chip">Qty<strong>${fmt.format(it.qty)}</strong></div>
            </div>

            <div class="note">${escapeHtml(it.note || " ")}</div>

            <div class="actions">
              <div class="qtyCtl">
                <button class="btn mini" data-act="dec" data-id="${escapeHtml(it.item_id)}">ï¼</button>
                <div class="qty">${fmt.format(it.qty)}</div>
                <button class="btn mini primary" data-act="inc" data-id="${escapeHtml(it.item_id)}">ï¼‹</button>
              </div>
              <div style="display:flex; gap:8px;">
                <button class="btn mini" data-act="edit" data-id="${escapeHtml(it.item_id)}">ç¼–è¾‘</button>
              </div>
            </div>
          </div>
        `;

        grid.appendChild(card);
      }

      // bind card buttons
      grid.querySelectorAll("button[data-act]").forEach(btn => {
        btn.addEventListener("click", () => {
          const act = btn.dataset.act;
          const id = btn.dataset.id;
          if(act === "inc") incQty(id);
          if(act === "dec") decQty(id);
          if(act === "edit") openEdit(id);
        });
      });
    }

    // ---------- Operations ----------
    function incQty(id){
      const it = items.find(x => x.item_id === id);
      if(!it) return;
      it.qty = Number(it.qty || 0) + 1;
      it.updated_at = new Date().toISOString();
      toast("good", "å·²æ›´æ–°", `${it.name}: æ•°é‡ +1`);
      render();
    }

    function decQty(id){
      const it = items.find(x => x.item_id === id);
      if(!it) return;
      it.qty = Number(it.qty || 0) - 1;

      if(it.qty <= 0){
        // rule: qty=0 auto delete
        items = items.filter(x => x.item_id !== id);
        toast("warn", "è‡ªåŠ¨åˆ é™¤", `${it.name}: æ•°é‡è¾¾åˆ°äº† 0`);
      }else{
        it.updated_at = new Date().toISOString();
        toast("good", "å·²æ›´æ–°", `${it.name}: æ•°é‡ -1`);
      }
      render();
    }

    function upsertFromModal(){
      const name = fName.value.trim();
      const price = Number(fPrice.value);
      const qty = Number(fQty.value);
      const img_url = fImg.value.trim();
      const note = fNote.value.trim();

      if(!name){
        toast("bad", "æ— æ•ˆçš„", "éœ€è¦ä¸€ä¸ªåå­—.");
        return;
      }
      if(!Number.isFinite(price) || price < 0){
        toast("bad", "æ— æ•ˆçš„", "ä»·æ ¼å¿…é¡»æ˜¯ä¸€ä¸ªéè´Ÿæ•´æ•°");
        return;
      }
      if(!Number.isFinite(qty) || qty < 0){
        toast("bad", "æ— æ•ˆçš„", "æ•°é‡å¿…é¡»æ˜¯ä¸€ä¸ªæ­£æ•´æ•°");
        return;
      }

      if(editingId){
        const it = items.find(x => x.item_id === editingId);
        if(!it) return;

        // qty=0 => delete
        if(qty <= 0){
          items = items.filter(x => x.item_id !== editingId);
          toast("warn", "å·²åˆ é™¤", `${it.name} æ•°é‡ä¸º 0 è‡ªåŠ¨åˆ é™¤`);
          closeModal();
          render();
          return;
        }

        it.name = name;
        it.price = Math.floor(price);
        it.qty = Math.floor(qty);
        it.img_url = img_url;
        it.note = note;
        it.updated_at = new Date().toISOString();

        toast("good", "å·²ä¿å­˜", `${it.name} å·²æ›´æ–°.`);
      }else{
        if(qty <= 0){
          toast("bad", "æ— æ•ˆçš„", "æ–°ç‰©å“çš„æ•°é‡å¿…é¡»æ˜¯ä¸€ä¸ªéè´Ÿæ•´æ•°");
          return;
        }
        const it = {
          item_id: genId(),
          name,
          price: Math.floor(price),
          qty: Math.floor(qty),
          img_url,
          note,
          updated_at: new Date().toISOString()
        };
        items.unshift(it);
        toast("good", "å·²æ·»åŠ ", `${it.name} å·²æ·»åŠ .`);
      }

      closeModal();
      render();
    }

    // ---------- Modal ----------
    function openAdd(){
      editingId = null;
      modalTitle.textContent = "æ·»åŠ å•†å“";
      deleteBtn.style.display = "none";
      fName.value = "";
      fPrice.value = "0";
      fQty.value = "1";
      fImg.value = "";
      fNote.value = "";
      openModal();
    }

    function openEdit(id){
      const it = items.find(x => x.item_id === id);
      if(!it) return;
      editingId = id;
      modalTitle.textContent = "ç¼–è¾‘å•†å“";
      deleteBtn.style.display = "inline-flex";
      fName.value = it.name;
      fPrice.value = String(it.price);
      fQty.value = String(it.qty);
      fImg.value = it.img_url || "";
      fNote.value = it.note || "";
      openModal();
    }

    function openModal(){
      modalBack.style.display = "flex";
      modalBack.setAttribute("aria-hidden", "false");
      setTimeout(()=> fName.focus(), 10);
    }

    function closeModal(){
      modalBack.style.display = "none";
      modalBack.setAttribute("aria-hidden", "true");
    }

    function deleteCurrent(){
      if(!editingId) return;
      const it = items.find(x => x.item_id === editingId);
      items = items.filter(x => x.item_id !== editingId);
      toast("warn", "å·²åˆ é™¤", `${it?.name || "Item"} å·²è¢«åˆ é™¤.`);
      closeModal();
      render();
    }

    // ---------- Events ----------
    searchInput.addEventListener("input", (e) => {
      searchQ = e.target.value || "";
      render();
    });

    sortSelect.addEventListener("change", (e) => {
      sortKey = e.target.value;
      render();
    });

    addBtn.addEventListener("click", openAdd);
    closeModalBtn.addEventListener("click", closeModal);
    cancelBtn.addEventListener("click", closeModal);
    saveBtn.addEventListener("click", upsertFromModal);
    deleteBtn.addEventListener("click", deleteCurrent);

    modalBack.addEventListener("click", (e) => {
      if(e.target === modalBack) closeModal();
    });

    window.addEventListener("keydown", (e) => {
      if(e.key === "Escape") closeModal();
      if(e.key === "Enter" && modalBack.style.display === "flex"){
        // é˜²æ­¢ textarea å›è½¦è¯¯è§¦ï¼šæŒ‰ä½ Shift å°±ä¸æäº¤
        if(document.activeElement === fNote && e.shiftKey) return;
        // åœ¨ modal ä¸­æŒ‰ Enter æäº¤
        upsertFromModal();
      }
    });

    // init
    render();
  </script>
</body>
</html>
